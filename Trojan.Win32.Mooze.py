from _winreg import *
import os

def checkFileExist(path):
	return os.path.isfile(path)

def checkRegistryExist(path):

    check = None
    
    try:
        # tach root_path example HKEY_LOCAL_MACHINE
        index = path.find('\\')

        root_path = path[:index]
        path = path[(index + 1):]

        # tach key example Pbt32
        index = path.rfind('\\')

        key = path[(index + 1):]
        path = path[:index]


        reg = None
        
        if root_path == 'HKEY_LOCAL_MACHINE':
            reg = ConnectRegistry(None, HKEY_LOCAL_MACHINE)
        elif (root_path == 'HKEY_CURRENT_USER'):
            reg = ConnectRegistry(None, HKEY_CURRENT_USER)
        elif root_path == 'HKEY_CLASSES_ROOT':
            reg = ConnectRegistry(None, HKEY_CLASSES_ROOT)
        elif root_path == 'HKEY_USERS':
            reg = ConnectRegistry(None, HKEY_USERS)
        else:
            reg = ConnectRegistry(None, HKEY_CURRENT_CONFIG)
        
        k = OpenKey(reg, path)
        
        value = QueryValueEx(k, key)

        check = True
    except:
        check = False

    return check

def deleteFile(path):
    os.remove(path)

def deleteRegistry(path):
    # tach root_path example HKEY_LOCAL_MACHINE
    index = path.find('\\')
	
    root_path = path[:index]
    path = path[(index + 1):]

    # tach key example Pbt32
    index = path.rfind('\\')

    key = path[(index + 1):]
    path = path[:index]
	
    hkey = OpenKey(HKEY_LOCAL_MACHINE, path, 0, KEY_ALL_ACCESS)
    DeleteValue(hkey, key)


check = None

# check file 
# C:\Windows\System32\Pbt32.exe

if checkFileExist('C:\Windows\System32\Pbt32.exe') == False:
    check = False
	
# check registry
# HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Pbt32

if checkRegistryExist('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Pbt32') == False:
    check = False

if check == False:
    print 'Can not found virus'
else:
	print 'Virus found'
	
	deleteFile('C:\Windows\System32\Pbt32.exe')
	print 'Delete file C:\Windows\System32\Pbt32.exe done!'
	
	#key = OpenKey(HKEY_LOCAL_MACHINE, 'SOFTWARE\Microsoft\Windows\CurrentVersion\Run', 0, KEY_ALL_ACCESS)
	#DeleteValue(key, 'Pbt32')
	deleteRegistry('HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Pbt32')
	
	print 'Delete registry HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Pbt32 done!' 
	
	
	