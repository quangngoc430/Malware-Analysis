from _winreg import *
import json
import os

def check_file_exist(path):
	return os.path.isfile(path)

def check_registry_exist(path):

    check = None
    
    try:
        index = path.find('\\')

        root_path = path[:index]
        path = path[(index + 1):]

        index = path.rfind('\\')

        key = path[(index + 1):]
        path = path[:index]

        reg = None
        
        if root_path == 'HKEY_LOCAL_MACHINE':
            reg = ConnectRegistry(None, HKEY_LOCAL_MACHINE)
        elif (root_path == 'HKEY_CURRENT_USER'):
            reg = ConnectRegistry(None, HKEY_CURRENT_USER)
        elif root_path == 'HKEY_CLASSES_ROOT':
            reg = ConnectRegistry(None, HKEY_CLASSES_ROOT)
        elif root_path == 'HKEY_USERS':
            reg = ConnectRegistry(None, HKEY_USERS)
        else:
            reg = ConnectRegistry(None, HKEY_CURRENT_CONFIG)
        
        k = OpenKey(reg, path)
        value = QueryValueEx(k, key)
        check = True
    except:
        check = False

    return check

def delete_file(path):
    os.remove(path)

def delete_registry(path):
    index = path.find('\\')
	
    root_path = path[:index]
    path = path[(index + 1):]

    index = path.rfind('\\')

    key = path[(index + 1):]
    path = path[:index]
	
    hkey = OpenKey(HKEY_LOCAL_MACHINE, path, 0, KEY_ALL_ACCESS)
    DeleteValue(hkey, key)

def read_file_json():
    with open('data.json') as json_file:
        data = json.load(json_file)
        return data

read_file_json()

for data_el in data:
    print('check virus ' + data_el['name'])

    check = None

    for file_name in data_el['file_created']:
        if check_file_exist(file_name) == False:
            check = False
    
    for hkey_name in data_el['hkey_created']:
        if check_registry_exist(hkey_name) == False:
            check = False

    if check == True:
        print('Virus ' + data_el['name'] + ' found!')

    for file_name in data_el['file_created']:
        if check_file_exist(file_name) == False:
            delete_file(file_name)
            print('Delete file ' + file_name + ' done!')
    
    for hkey_name in data_el['hkey_created']:
        if check_registry_exist(hkey_name) == False:
            delete_registry(hkey_name)
            print('Delete registry ' + hkey_name + ' done!')